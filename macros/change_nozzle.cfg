[gcode_macro CHANGE_NOZZLE]
description: Position Revo nozzle and retract filament to allow nozzle change
gcode:
  {% set max_x = printer.toolhead.axis_maximum.x|float %}
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  
  # Default position is center forward and high up
  {% set x = params.X|default(max_x/2) %}
  {% set y = params.Y|default(10) %}
  {% set z = params.Z|default((max_z/4)*3) %}

  {% set len = params.LENGTH|default(25) %} # 25mm for Revo
  {% set temp = params.TEMP|default(180) %}

  SAVE_GCODE_STATE NAME=CHANGE_NOZZLE_state

  G90 # Absolute positioning
  M83 # Extruder relative mode
  G28 # Home toolhead

  M104 S{temp} # Start heating nozzle

  # Do not move Z if already past desired position
  {% if printer.toolhead.position.z > z %}
    {% set z = printer.toolhead.position.z %}
  {% endif %}

  G0 X{x} Y{y} Z{z} F5000 # Move to change position

  M109 S{temp}     # Wait for nozzle to reach temperature
  G1 E-{len} F1500 # Retract filament

  M106 S255 # Use part fan to help nozzle cool down
  M109 S40  # Wait for nozzle to cool down to 40deg (safe to touch)
  M300      #Â Beep to indicate ready to change

  M106 S0 # Turn off cooling fan
  M104 S0 # Turn off heater
  
  RESTORE_GCODE_STATE NAME=CHANGE_NOZZLE_state
