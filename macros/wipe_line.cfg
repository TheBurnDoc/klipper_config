[gcode_macro WIPE_LINE]
description: Prime nozzle before print
gcode:
  {% set z = params.Z|default(0.25)|float %}
  {% set y = params.Y|default(5)|float %}
  {% set n = params.N|default(0.4)|float %}
  {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
  {% set len = params.LENGTH|default(max_x/3)|float %}
  {% set e = params.EXTRUDE|default(len/4) %}
  {% set x0 = params.X|default(5) %}
  {% set x1 = x0 + len %}

  {% if printer.toolhead.homed_axes != "xyz" %}
    {action_respond_info("Please home XYZ first")}
  {% elif printer.extruder.temperature < 170 %}
    {action_respond_info("Extruder temperature too low")}
  {% else %}
    SAVE_GCODE_STATE NAME=WIPE_LINE_state

    M82    # Absolute extrusion
    G90    # Absolute positioning
    G92 E0 # Reset extruder

    G1 X{x0} Y{y} Z5 F3000   # Initial position 5mm above plate
    G1 Z{z} F3000            # Lower nozzle
    G1 X{x1} Y{y} F1500 E{e} # Initial light extrusion wipe 
    G1 Y{y+0.4} F5000        # Move nozzle for return wipe
    G1 X{x0} F1500 E{e*2}    # Heavy return wipe
    G1 Y{y+4} Z1.5 F5000     # Jerk nozzle away from wipe line

    RESTORE_GCODE_STATE NAME=WIPE_LINE_state MOVE=0
  {% endif %}